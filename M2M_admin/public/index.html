<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M2M Admin - ì˜ìƒ ëª¨ë‹ˆí„°ë§ ë° ì¬ìƒì„±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 24px;
      color: #333;
    }
    .section {
      margin-bottom: 32px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .section h2 {
      margin-bottom: 16px;
      font-size: 18px;
      color: #555;
    }
    input, button {
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    input {
      min-width: 200px;
      margin-right: 8px;
    }
    button {
      background: #111;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover:not(:disabled) {
      background: #333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }
    .video-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      background: white;
    }
    .video-card h3 {
      margin-bottom: 8px;
      font-size: 16px;
      color: #333;
    }
    .video-card p {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    video {
      width: 100%;
      max-width: 100%;
      border-radius: 6px;
      margin-bottom: 12px;
      background: #000;
    }
    .regenerate-btn {
      width: 100%;
      padding: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .regenerate-btn:hover:not(:disabled) {
      background: #ff5252;
    }
    .regenerate-btn:disabled {
      background: #ccc;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ M2M Admin - ì˜ìƒ ëª¨ë‹ˆí„°ë§ ë° ì¬ìƒì„±</h1>

    <!-- 1ë‹¨ê³„: ì„¸ì…˜ ID ì…ë ¥ -->
    <div class="section">
      <h2>1ë‹¨ê³„: ì„¸ì…˜ ID ì…ë ¥</h2>
      <div>
        <input type="text" id="sessionIdInput" placeholder="ì„¸ì…˜ ID ì…ë ¥ (ì˜ˆ: P1)" />
        <button id="createSessionBtn">ì„¸ì…˜ ìƒì„±</button>
      </div>
      <div id="sessionStatus"></div>
    </div>

    <!-- 2ë‹¨ê³„: DB ë¡œë“œ -->
    <div class="section">
      <h2>2ë‹¨ê³„: DBì—ì„œ ë°ì´í„° ë¡œë“œ</h2>
      <button id="loadFromDbBtn" disabled>DB ë¡œë“œ</button>
      <div id="loadStatus"></div>
    </div>

    <!-- 3ë‹¨ê³„: ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ë° ì¬ìƒì„± -->
    <div class="section">
      <h2>3ë‹¨ê³„: ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ë° ì¬ìƒì„±</h2>
      <div id="videosContainer">
        <p style="color: #999;">ë¨¼ì € ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  DB ë¡œë“œë¥¼ ì™„ë£Œí•˜ì„¸ìš”.</p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:3002";
    let currentSessionId = null;
    let videosData = [];

    // ì„¸ì…˜ ìƒì„±
    document.getElementById("createSessionBtn").addEventListener("click", async () => {
      const sessionId = document.getElementById("sessionIdInput").value.trim();
      if (!sessionId) {
        showStatus("sessionStatus", "ì„¸ì…˜ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/session/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId }),
        });
        const json = await res.json();
        
        if (!json.ok) {
          showStatus("sessionStatus", "ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: " + (json.error || ""), "error");
          return;
        }

        currentSessionId = json.sessionId;
        document.getElementById("loadFromDbBtn").disabled = false;
        showStatus("sessionStatus", `âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ: ${json.sessionId}`, "success");
      } catch (e) {
        showStatus("sessionStatus", "ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: " + e.message, "error");
      }
    });

    // DB ë¡œë“œ
    document.getElementById("loadFromDbBtn").addEventListener("click", async () => {
      if (!currentSessionId) {
        showStatus("loadStatus", "ë¨¼ì € ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  ì„¸ì…˜ì„ ìƒì„±í•˜ì„¸ìš”.", "error");
        return;
      }

      const btn = document.getElementById("loadFromDbBtn");
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> DB ë¡œë“œ ì¤‘...';
      showStatus("loadStatus", "DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...", "info");

      try {
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/load-from-db`, {
          method: "POST",
        });
        const json = await res.json();

        if (!json.ok) {
          showStatus("loadStatus", "DB ë¡œë“œ ì‹¤íŒ¨: " + (json.error || ""), "error");
          btn.disabled = false;
          btn.textContent = "DB ë¡œë“œ";
          return;
        }

        showStatus("loadStatus", `âœ… DB ë¡œë“œ ì™„ë£Œ! ì´ë¯¸ì§€ ${json.downloadedImages?.length || 0}ê°œ ë‹¤ìš´ë¡œë“œë¨`, "success");
        
        // ë¹„ë””ì˜¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        await loadVideos();
      } catch (e) {
        showStatus("loadStatus", "DB ë¡œë“œ ì‹¤íŒ¨: " + e.message, "error");
        btn.disabled = false;
        btn.textContent = "DB ë¡œë“œ";
      }
    });

    // ë¹„ë””ì˜¤ ëª©ë¡ ë¡œë“œ
    async function loadVideos() {
      if (!currentSessionId) return;

      try {
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/videos`);
        const json = await res.json();

        if (!json.ok) {
          console.error("ë¹„ë””ì˜¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", json.error);
          return;
        }

        videosData = json.videos || [];
        renderVideos();
      } catch (e) {
        console.error("ë¹„ë””ì˜¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
      }
    }

    // ë¹„ë””ì˜¤ ë Œë”ë§
    function renderVideos() {
      const container = document.getElementById("videosContainer");
      
      if (!videosData.length) {
        container.innerHTML = "<p style='color: #999;'>ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      container.innerHTML = '<div class="videos-grid"></div>';
      const grid = container.querySelector(".videos-grid");

      videosData.forEach((video) => {
        const card = document.createElement("div");
        card.className = "video-card";
        card.innerHTML = `
          <h3>ì”¬ ID: ${video.scene_id}</h3>
          <p>${video.prompt_text || ""}</p>
          ${video.video_url ? `
            <video controls>
              <source src="${video.video_url}" type="video/mp4">
              ë¹„ë””ì˜¤ë¥¼ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </video>
          ` : '<p style="color: #999;">ë¹„ë””ì˜¤ URLì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
          <button class="regenerate-btn" data-scene-id="${video.scene_id}">
            ğŸ”„ ì¬ìƒì„±
          </button>
        `;
        grid.appendChild(card);
      });

      // ì¬ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
      document.querySelectorAll(".regenerate-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const sceneId = btn.dataset.sceneId;
          await regenerateVideo(sceneId, btn);
        });
      });
    }

    // ë¹„ë””ì˜¤ ì¬ìƒì„±
    async function regenerateVideo(sceneId, btnElement) {
      if (!currentSessionId) return;

      btnElement.disabled = true;
      btnElement.innerHTML = '<span class="loading"></span> ì¬ìƒì„± ì¤‘...';

      try {
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/regenerate/${sceneId}`, {
          method: "POST",
        });
        const json = await res.json();

        if (!json.ok) {
          alert("ì¬ìƒì„± ì‹¤íŒ¨: " + (json.error || ""));
          btnElement.disabled = false;
          btnElement.textContent = "ğŸ”„ ì¬ìƒì„±";
          return;
        }

        alert(`âœ… ì¬ìƒì„± ì™„ë£Œ! ìƒˆ ë¹„ë””ì˜¤ URL: ${json.newVideoUrl}`);
        
        // ë¹„ë””ì˜¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadVideos();
      } catch (e) {
        alert("ì¬ìƒì„± ì‹¤íŒ¨: " + e.message);
        btnElement.disabled = false;
        btnElement.textContent = "ğŸ”„ ì¬ìƒì„±";
      }
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
  </script>
</body>
</html>
