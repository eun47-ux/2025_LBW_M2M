<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M2M Admin - ì˜ìƒ ëª¨ë‹ˆí„°ë§ ë° ì¬ìƒì„±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-bottom: 24px;
      color: #333;
    }
    .section {
      margin-bottom: 32px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    .section h2 {
      margin-bottom: 16px;
      font-size: 18px;
      color: #555;
    }
    input, button {
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    input {
      min-width: 200px;
      margin-right: 8px;
    }
    button {
      background: #111;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover:not(:disabled) {
      background: #333;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }
    .video-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      background: white;
    }
    .video-card h3 {
      margin-bottom: 8px;
      font-size: 16px;
      color: #333;
    }
    .video-card p {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    video {
      width: 100%;
      max-width: 100%;
      border-radius: 6px;
      margin-bottom: 12px;
      background: #000;
    }
    img {
      width: 100%;
      max-width: 100%;
      border-radius: 6px;
      margin-bottom: 12px;
      background: #f0f0f0;
    }
    .scene-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      background: white;
      margin-bottom: 16px;
    }
    .scene-card textarea {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      margin-bottom: 12px;
    }
    .save-scene-btn {
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-right: 8px;
    }
    .save-scene-btn:hover:not(:disabled) {
      background: #1976D2;
    }
    .regenerate-image-btn {
      padding: 8px 16px;
      background: #ff9800;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .regenerate-image-btn:hover:not(:disabled) {
      background: #f57c00;
    }
    .regenerate-btn {
      width: 100%;
      padding: 10px;
      background: #ff6b6b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .regenerate-btn:hover:not(:disabled) {
      background: #ff5252;
    }
    .regenerate-btn:disabled {
      background: #ccc;
    }
    .refresh-btn {
      width: 40px;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .refresh-btn:hover:not(:disabled) {
      background: #45a049;
    }
    .refresh-btn:disabled {
      background: #ccc;
    }
    .refresh-image-btn {
      width: 40px;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .refresh-image-btn:hover:not(:disabled) {
      background: #45a049;
    }
    .refresh-image-btn:disabled {
      background: #ccc;
    }
    .button-group {
      display: flex;
      gap: 8px;
    }
    .button-group button {
      flex: 1;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ M2M Admin - ì˜ìƒ ëª¨ë‹ˆí„°ë§ ë° ì¬ìƒì„±</h1>

    <!-- 1ë‹¨ê³„: ì„¸ì…˜ ID ì…ë ¥ -->
    <div class="section">
      <h2>1ë‹¨ê³„: ì„¸ì…˜ ID ì…ë ¥</h2>
      <div>
        <input type="text" id="sessionIdInput" placeholder="ì„¸ì…˜ ID ì…ë ¥ (ì˜ˆ: P1)" />
        <button id="createSessionBtn">ì„¸ì…˜ ìƒì„±</button>
      </div>
      <div id="sessionStatus"></div>
    </div>

    <!-- 2ë‹¨ê³„: DB ë¡œë“œ -->
    <div class="section">
      <h2>2ë‹¨ê³„: DBì—ì„œ ë°ì´í„° ë¡œë“œ</h2>
      <button id="loadFromDbBtn" disabled>DB ë¡œë“œ</button>
      <div id="loadStatus"></div>
    </div>

    <!-- 3ë‹¨ê³„: ì”¬ í¸ì§‘ -->
    <div class="section">
      <h2>3ë‹¨ê³„: ì”¬ í¸ì§‘</h2>
      <div id="scenesContainer">
        <p style="color: #999;">ë¨¼ì € ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  DB ë¡œë“œë¥¼ ì™„ë£Œí•˜ì„¸ìš”.</p>
      </div>
    </div>

    <!-- 4ë‹¨ê³„: ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ì¬ìƒì„± -->
    <div class="section">
      <h2>4ë‹¨ê³„: ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ì¬ìƒì„±</h2>
      <div id="imagesContainer">
        <p style="color: #999;">ë¨¼ì € ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  DB ë¡œë“œë¥¼ ì™„ë£Œí•˜ì„¸ìš”.</p>
      </div>
    </div>

    <!-- 5ë‹¨ê³„: ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ë° ì¬ìƒì„± -->
    <div class="section">
      <h2>5ë‹¨ê³„: ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ë° ì¬ìƒì„±</h2>
      <div id="videosContainer">
        <p style="color: #999;">ë¨¼ì € ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  DB ë¡œë“œë¥¼ ì™„ë£Œí•˜ì„¸ìš”.</p>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:3002";
    let currentSessionId = null;
    let videosData = [];
    let scenesData = null;
    let imagesData = [];

    // ì„¸ì…˜ ìƒì„±
    document.getElementById("createSessionBtn").addEventListener("click", async () => {
      const sessionId = document.getElementById("sessionIdInput").value.trim();
      if (!sessionId) {
        showStatus("sessionStatus", "ì„¸ì…˜ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/session/create`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId }),
        });
        const json = await res.json();
        
        if (!json.ok) {
          showStatus("sessionStatus", "ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: " + (json.error || ""), "error");
          return;
        }

        currentSessionId = json.sessionId;
        document.getElementById("loadFromDbBtn").disabled = false;
        showStatus("sessionStatus", `âœ… ì„¸ì…˜ ìƒì„± ì™„ë£Œ: ${json.sessionId}`, "success");
      } catch (e) {
        showStatus("sessionStatus", "ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: " + e.message, "error");
      }
    });

    // DB ë¡œë“œ
    document.getElementById("loadFromDbBtn").addEventListener("click", async () => {
      if (!currentSessionId) {
        showStatus("loadStatus", "ë¨¼ì € ì„¸ì…˜ IDë¥¼ ì…ë ¥í•˜ê³  ì„¸ì…˜ì„ ìƒì„±í•˜ì„¸ìš”.", "error");
        return;
      }

      const btn = document.getElementById("loadFromDbBtn");
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> DB ë¡œë“œ ì¤‘...';
      showStatus("loadStatus", "DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...", "info");

      try {
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/load-from-db`, {
          method: "POST",
        });
        const json = await res.json();

        if (!json.ok) {
          showStatus("loadStatus", "DB ë¡œë“œ ì‹¤íŒ¨: " + (json.error || ""), "error");
          btn.disabled = false;
          btn.textContent = "DB ë¡œë“œ";
          return;
        }

        showStatus("loadStatus", `âœ… DB ë¡œë“œ ì™„ë£Œ! ì´ë¯¸ì§€ ${json.downloadedImages?.length || 0}ê°œ ë‹¤ìš´ë¡œë“œë¨`, "success");
        
        // ì”¬ ë°ì´í„° ë¡œë“œ
        scenesData = json.scenesJson;
        if (scenesData) {
          renderScenes();
        }
        
        // ì´ë¯¸ì§€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        imagesData = json.downloadedImages || [];
        renderImages();
        
        // ë¹„ë””ì˜¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        await loadVideos();
        
        // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        btn.disabled = false;
        btn.textContent = "DB ë¡œë“œ";
      } catch (e) {
        showStatus("loadStatus", "DB ë¡œë“œ ì‹¤íŒ¨: " + e.message, "error");
        btn.disabled = false;
        btn.textContent = "DB ë¡œë“œ";
      }
    });

    // ì”¬ ë Œë”ë§
    function renderScenes() {
      const container = document.getElementById("scenesContainer");
      
      if (!scenesData || !scenesData.scenes || !scenesData.scenes.length) {
        container.innerHTML = "<p style='color: #999;'>ì”¬ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      container.innerHTML = '<div class="videos-grid"></div>';
      const grid = container.querySelector(".videos-grid");

      scenesData.scenes.forEach((scene) => {
        const card = document.createElement("div");
        card.className = "scene-card";
        card.setAttribute("data-scene-id", scene.scene_id);
        card.innerHTML = `
          <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 12px;">ì”¬ ID:</label>
          <input type="text" class="scene-id-input" data-scene-id="${scene.scene_id}" value="${scene.scene_id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; margin-bottom: 12px;">
          <p>Pair: ${scene.pair?.join(", ") || ""}</p>
          <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 12px;">ì”¬ í…ìŠ¤íŠ¸:</label>
          <textarea class="scene-text-input" data-scene-id="${scene.scene_id}">${scene.scene_text || ""}</textarea>
          <div class="button-group">
            <button class="save-scene-btn" data-scene-id="${scene.scene_id}">ğŸ’¾ ì”¬ ì €ì¥</button>
            <button class="regenerate-image-btn" data-scene-id="${scene.scene_id}">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì¬ìƒì„±</button>
          </div>
        `;
        grid.appendChild(card);
      });

      // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
      container.addEventListener("click", async (e) => {
        const saveBtn = e.target.closest(".save-scene-btn");
        if (saveBtn) {
          const sceneId = saveBtn.dataset.sceneId;
          await saveScene(sceneId);
          return;
        }

        const regenerateBtn = e.target.closest(".regenerate-image-btn");
        if (regenerateBtn) {
          const sceneId = regenerateBtn.dataset.sceneId;
          await regenerateImageFromUI(sceneId, regenerateBtn);
          return;
        }
      });
    }

    // ì”¬ ì €ì¥
    async function saveScene(sceneId) {
      if (!scenesData || !currentSessionId) return;

      const card = document.querySelector(`.scene-card[data-scene-id="${sceneId}"]`);
      if (!card) return;

      const sceneIdInput = card.querySelector(`.scene-id-input[data-scene-id="${sceneId}"]`);
      const textarea = card.querySelector(`.scene-text-input[data-scene-id="${sceneId}"]`);
      
      if (!sceneIdInput || !textarea) return;

      const newSceneId = sceneIdInput.value.trim();
      const newSceneText = textarea.value.trim();

      if (!newSceneId) {
        alert("ì”¬ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (!newSceneText) {
        alert("ì”¬ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // scenesData ì—…ë°ì´íŠ¸
      const scene = scenesData.scenes.find((s) => s.scene_id === sceneId);
      if (scene) {
        const oldSceneId = scene.scene_id;
        scene.scene_id = newSceneId;
        scene.scene_text = newSceneText;

        // scene_idê°€ ë³€ê²½ëœ ê²½ìš° ì¹´ë“œì˜ data-scene-id ì†ì„±ë„ ì—…ë°ì´íŠ¸
        if (oldSceneId !== newSceneId) {
          card.setAttribute("data-scene-id", newSceneId);
          sceneIdInput.setAttribute("data-scene-id", newSceneId);
          textarea.setAttribute("data-scene-id", newSceneId);
          
          // ë²„íŠ¼ë“¤ì˜ data-scene-idë„ ì—…ë°ì´íŠ¸
          const saveBtn = card.querySelector(".save-scene-btn");
          const regenerateBtn = card.querySelector(".regenerate-image-btn");
          if (saveBtn) saveBtn.setAttribute("data-scene-id", newSceneId);
          if (regenerateBtn) regenerateBtn.setAttribute("data-scene-id", newSceneId);
        }
      }

      try {
        const res = await fetch(`${API_BASE}/api/scenes/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId: currentSessionId,
            scenesJson: scenesData,
          }),
        });
        const json = await res.json();

        if (!json.ok) {
          alert("ì”¬ ì €ì¥ ì‹¤íŒ¨: " + (json.error || ""));
          return;
        }

        alert("âœ… ì”¬ ì €ì¥ ì™„ë£Œ!");
      } catch (e) {
        alert("ì”¬ ì €ì¥ ì‹¤íŒ¨: " + e.message);
      }
    }

    // ì´ë¯¸ì§€ ë Œë”ë§
    function renderImages() {
      const container = document.getElementById("imagesContainer");
      
      if (!imagesData || !imagesData.length) {
        container.innerHTML = "<p style='color: #999;'>ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      container.innerHTML = '<div class="videos-grid"></div>';
      const grid = container.querySelector(".videos-grid");

      imagesData.forEach((image) => {
        const imageUrl = `/sessions/${currentSessionId}/images/${image.sceneId}.png`;
        const card = document.createElement("div");
        card.className = "video-card";
        card.setAttribute("data-scene-id", image.sceneId);
        card.innerHTML = `
          <h3>ì”¬ ID: ${image.sceneId}</h3>
          <img src="${imageUrl}" alt="${image.sceneId}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <p style="display: none; color: #999;">ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
          <div class="button-group">
            <button class="regenerate-image-btn" data-scene-id="${image.sceneId}">ğŸ–¼ï¸ ì´ë¯¸ì§€ ì¬ìƒì„±</button>
            <button class="refresh-image-btn" data-scene-id="${image.sceneId}">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
              </svg>
            </button>
          </div>
        `;
        grid.appendChild(card);
      });

      // ì´ë²¤íŠ¸ ìœ„ì„ì„ í•œ ë²ˆë§Œ ë“±ë¡ (ì¤‘ë³µ ë°©ì§€)
      if (container && !container.dataset.listenerAttached) {
        container.dataset.listenerAttached = "true";
        
        container.addEventListener("click", async (e) => {
          const regenerateBtn = e.target.closest(".regenerate-image-btn");
          if (regenerateBtn) {
            e.preventDefault();
            e.stopPropagation();
            const sceneId = regenerateBtn.dataset.sceneId;
            await regenerateImageFromUI(sceneId, regenerateBtn);
            return;
          }
          
          const refreshBtn = e.target.closest(".refresh-image-btn");
          if (refreshBtn) {
            e.preventDefault();
            e.stopPropagation();
            const sceneId = refreshBtn.dataset.sceneId;
            await refreshImage(sceneId, refreshBtn);
            return;
          }
        });
      }
    }

    // ì´ë¯¸ì§€ ì¬ìƒì„± (UIì—ì„œ í˜¸ì¶œ)
    async function regenerateImageFromUI(sceneId, btn) {
      if (!currentSessionId) return;

      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> ì¬ìƒì„± ì¤‘...';

      try {
        const res = await fetch(`${API_BASE}/api/regenerate/image`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId: currentSessionId,
            sceneId: sceneId,
          }),
        });
        const json = await res.json();

        if (!json.ok) {
          alert("ì´ë¯¸ì§€ ì¬ìƒì„± ì‹¤íŒ¨: " + (json.error || ""));
          btn.disabled = false;
          btn.textContent = "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì¬ìƒì„±";
          return;
        }

        alert("âœ… ì´ë¯¸ì§€ ì¬ìƒì„± ì™„ë£Œ!");
        
        // ì´ë¯¸ì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadImages();
        
        btn.disabled = false;
        btn.textContent = "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì¬ìƒì„±";
      } catch (e) {
        alert("ì´ë¯¸ì§€ ì¬ìƒì„± ì‹¤íŒ¨: " + e.message);
        btn.disabled = false;
        btn.textContent = "ğŸ–¼ï¸ ì´ë¯¸ì§€ ì¬ìƒì„±";
      }
    }

    // ì´ë¯¸ì§€ ìƒˆë¡œê³ ì¹¨ (í•´ë‹¹ ì”¬ë§Œ)
    async function refreshImage(sceneId, btnElement) {
      if (!currentSessionId) return;

      btnElement.disabled = true;
      btnElement.innerHTML = '<span class="loading"></span> ìƒˆë¡œê³ ì¹¨ ì¤‘...';

      try {
        // DBì—ì„œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/load-from-db`, {
          method: "POST",
        });
        const json = await res.json();

        if (!json.ok) {
          alert("ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + (json.error || ""));
          btnElement.disabled = false;
          btnElement.innerHTML = `
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
          `;
          return;
        }

        // í•´ë‹¹ ì”¬ì˜ ì´ë¯¸ì§€ ì •ë³´ ì°¾ê¸°
        const updatedImage = json.downloadedImages?.find((img) => img.sceneId === sceneId);
        if (!updatedImage) {
          alert(`ì”¬ ${sceneId}ì˜ ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
          btnElement.disabled = false;
          btnElement.innerHTML = `
            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
          `;
          return;
        }

        // imagesData ì—…ë°ì´íŠ¸
        const index = imagesData.findIndex((img) => img.sceneId === sceneId);
        if (index >= 0) {
          imagesData[index] = updatedImage;
        } else {
          imagesData.push(updatedImage);
        }

        // í•´ë‹¹ ì¹´ë“œì˜ ì´ë¯¸ì§€ë§Œ ì—…ë°ì´íŠ¸
        const card = document.querySelector(`.video-card[data-scene-id="${sceneId}"]`);
        if (card) {
          const img = card.querySelector("img");
          if (img) {
            const newImageUrl = `/sessions/${currentSessionId}/images/${sceneId}.png`;
            img.src = newImageUrl + "?t=" + Date.now(); // ìºì‹œ ë°©ì§€
          }
        }

        btnElement.disabled = false;
        btnElement.innerHTML = `
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
          </svg>
        `;
      } catch (e) {
        alert("ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + e.message);
        btnElement.disabled = false;
        btnElement.innerHTML = `
          <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
          </svg>
        `;
      }
    }

    // ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ
    async function loadImages() {
      if (!currentSessionId) return;

      try {
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/load-from-db`, {
          method: "POST",
        });
        const json = await res.json();

        if (json.ok) {
          imagesData = json.downloadedImages || [];
          renderImages();
        }
      } catch (e) {
        console.error("ì´ë¯¸ì§€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
      }
    }

    // ë¹„ë””ì˜¤ ëª©ë¡ ë¡œë“œ
    async function loadVideos() {
      if (!currentSessionId) return;

      try {
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/videos`);
        const json = await res.json();

        if (!json.ok) {
          console.error("ë¹„ë””ì˜¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", json.error);
          return;
        }

        videosData = json.videos || [];
        console.log("ë¹„ë””ì˜¤ ë°ì´í„°:", videosData); // ë””ë²„ê¹…ìš©
        renderVideos();
      } catch (e) {
        console.error("ë¹„ë””ì˜¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", e);
      }
    }

    // ë¹„ë””ì˜¤ ë Œë”ë§
    function renderVideos() {
      const container = document.getElementById("videosContainer");
      
      if (!videosData.length) {
        container.innerHTML = "<p style='color: #999;'>ë¹„ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
      }

      console.log("ë Œë”ë§í•  ë¹„ë””ì˜¤ ê°œìˆ˜:", videosData.length); // ë””ë²„ê¹…ìš©

      container.innerHTML = '<div class="videos-grid"></div>';
      const grid = container.querySelector(".videos-grid");

      videosData.forEach((video) => {
        // URLì´ ì ˆëŒ€ URLì´ ì•„ë‹ˆë©´ http:// ì¶”ê°€
        let videoUrl = video.video_url;
        if (videoUrl) {
          // URL ì •ê·œí™”: http:/ ë˜ëŠ” https:/ë¥¼ http:// ë˜ëŠ” https://ë¡œ ë³€í™˜
          videoUrl = videoUrl.replace(/^https?:\//, (match) => match + "/");
          
          // ì´ë¯¸ ì ˆëŒ€ URLì¸ì§€ í™•ì¸ (http:// ë˜ëŠ” https://ë¡œ ì‹œì‘)
          const isAbsolute = videoUrl.match(/^https?:\/\//);
          if (!isAbsolute) {
            // ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš°ì—ë§Œ base URL ì¶”ê°€
            const base = "http://143.248.107.38:8186";
            videoUrl = videoUrl.startsWith("/") 
              ? `${base}${videoUrl}`
              : `${base}/${videoUrl}`;
          }
        }
        
        console.log(`ë¹„ë””ì˜¤ ${video.scene_id} URL:`, videoUrl); // ë””ë²„ê¹…ìš©
        
        const card = document.createElement("div");
        card.className = "video-card";
        card.setAttribute("data-scene-id", video.scene_id);
        card.innerHTML = `
          <h3>ì”¬ ID: ${video.scene_id}</h3>
          <p>${video.prompt_text || ""}</p>
          <div class="video-wrapper" data-scene-id="${video.scene_id}">
            ${videoUrl ? `
              <video controls>
                <source src="${videoUrl}" type="video/mp4">
                ë¹„ë””ì˜¤ë¥¼ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
              </video>
            ` : '<p style="color: #999;">ë¹„ë””ì˜¤ URLì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
          </div>
          <div class="button-group">
            <button class="regenerate-btn" data-scene-id="${video.scene_id}">
              ğŸ”„ ì¬ìƒì„±
            </button>
            <button class="refresh-btn" data-scene-id="${video.scene_id}">
              ğŸ”ƒ ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
        `;
        grid.appendChild(card);
      });

      // ì´ë²¤íŠ¸ ìœ„ì„ì„ í•œ ë²ˆë§Œ ë“±ë¡ (ì¤‘ë³µ ë°©ì§€)
      const videosContainer = document.getElementById("videosContainer");
      if (videosContainer && !videosContainer.dataset.listenerAttached) {
        videosContainer.dataset.listenerAttached = "true";
        
        videosContainer.addEventListener("click", async (e) => {
          const regenerateBtn = e.target.closest(".regenerate-btn");
          if (regenerateBtn) {
            e.preventDefault();
            e.stopPropagation();
            const sceneId = regenerateBtn.dataset.sceneId;
            await regenerateVideo(sceneId, regenerateBtn);
            return;
          }
          
          const refreshBtn = e.target.closest(".refresh-btn");
          if (refreshBtn) {
            e.preventDefault();
            e.stopPropagation();
            const sceneId = refreshBtn.dataset.sceneId;
            await refreshVideo(sceneId, refreshBtn);
            return;
          }
        });
      }
    }

    // ë¹„ë””ì˜¤ ì¬ìƒì„±
    async function regenerateVideo(sceneId, btnElement) {
      if (!currentSessionId) return;

      btnElement.disabled = true;
      btnElement.innerHTML = '<span class="loading"></span> ì¬ìƒì„± ì¤‘...';

      try {
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/regenerate/${sceneId}`, {
          method: "POST",
        });
        const json = await res.json();

        if (!json.ok) {
          alert("ì¬ìƒì„± ì‹¤íŒ¨: " + (json.error || ""));
          btnElement.disabled = false;
          btnElement.textContent = "ğŸ”„ ì¬ìƒì„±";
          return;
        }

        alert(`âœ… ì¬ìƒì„± ì™„ë£Œ! ìƒˆ ë¹„ë””ì˜¤ URL: ${json.newVideoUrl}`);
        
        // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™” (ë¹¨ê°„ìƒ‰ìœ¼ë¡œ)
        btnElement.disabled = false;
        btnElement.textContent = "ğŸ”„ ì¬ìƒì„±";
        
        // ë¹„ë””ì˜¤ ëª©ë¡ì€ DB ë¡œë“œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ ìƒˆë¡œê³ ì¹¨
      } catch (e) {
        alert("ì¬ìƒì„± ì‹¤íŒ¨: " + e.message);
        btnElement.disabled = false;
        btnElement.textContent = "ğŸ”„ ì¬ìƒì„±";
      }
    }

    // ë¹„ë””ì˜¤ ìƒˆë¡œê³ ì¹¨ (í•´ë‹¹ ì”¬ë§Œ)
    async function refreshVideo(sceneId, btnElement) {
      if (!currentSessionId) return;

      btnElement.disabled = true;
      btnElement.innerHTML = '<span class="loading"></span> ìƒˆë¡œê³ ì¹¨ ì¤‘...';

      try {
        // DBì—ì„œ ìµœì‹  ì •ë³´ ê°€ì ¸ì˜¤ê¸° (refresh=true)
        const res = await fetch(`${API_BASE}/api/session/${currentSessionId}/videos?refresh=true`);
        const json = await res.json();

        if (!json.ok) {
          alert("ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + (json.error || ""));
          btnElement.disabled = false;
          btnElement.textContent = "ğŸ”ƒ ìƒˆë¡œê³ ì¹¨";
          return;
        }

        // í•´ë‹¹ ì”¬ì˜ ë¹„ë””ì˜¤ ì •ë³´ ì°¾ê¸°
        const updatedVideo = json.videos?.find((v) => v.scene_id === sceneId);
        if (!updatedVideo) {
          alert(`ì”¬ ${sceneId}ì˜ ë¹„ë””ì˜¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
          btnElement.disabled = false;
          btnElement.textContent = "ğŸ”ƒ ìƒˆë¡œê³ ì¹¨";
          return;
        }

        // videosData ì—…ë°ì´íŠ¸
        const index = videosData.findIndex((v) => v.scene_id === sceneId);
        if (index >= 0) {
          videosData[index] = updatedVideo;
        } else {
          videosData.push(updatedVideo);
        }

        // í•´ë‹¹ ì¹´ë“œì˜ ë¹„ë””ì˜¤ë§Œ ì—…ë°ì´íŠ¸
        const card = document.querySelector(`.video-card[data-scene-id="${sceneId}"]`);
        if (card) {
          const videoWrapper = card.querySelector(".video-wrapper");
          if (videoWrapper) {
            if (updatedVideo.video_url) {
              // URL ì •ê·œí™”: http:/ ë˜ëŠ” https:/ë¥¼ http:// ë˜ëŠ” https://ë¡œ ë³€í™˜
              let videoUrl = updatedVideo.video_url.replace(/^https?:\//, (match) => match + "/");
              
              // URLì´ ì ˆëŒ€ URLì¸ì§€ í™•ì¸ (http:// ë˜ëŠ” https://ë¡œ ì‹œì‘)
              const isAbsolute = videoUrl.match(/^https?:\/\//);
              if (!isAbsolute) {
                // ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš°ì—ë§Œ base URL ì¶”ê°€
                const base = "http://143.248.107.38:8186";
                videoUrl = videoUrl.startsWith("/") 
                  ? `${base}${videoUrl}`
                  : `${base}/${videoUrl}`;
              }
              
              // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
              const cacheBuster = `?t=${Date.now()}`;
              videoWrapper.innerHTML = `
                <video controls>
                  <source src="${videoUrl}${cacheBuster}" type="video/mp4">
                  ë¹„ë””ì˜¤ë¥¼ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                </video>
              `;
            } else {
              videoWrapper.innerHTML = '<p style="color: #999;">ë¹„ë””ì˜¤ URLì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
          }
        }

        btnElement.disabled = false;
        btnElement.textContent = "ğŸ”ƒ ìƒˆë¡œê³ ì¹¨";
      } catch (e) {
        alert("ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: " + e.message);
        btnElement.disabled = false;
        btnElement.textContent = "ğŸ”ƒ ìƒˆë¡œê³ ì¹¨";
      }
    }

    // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
    function showStatus(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
  </script>
</body>
</html>
